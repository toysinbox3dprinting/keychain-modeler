const path = require('path');
const { build } = require('esbuild');

const projectRoot = path.resolve(__dirname, '..');
const generatedBanner = '/* Generated by npm run generate:adapters. Do not edit directly. */';

const bundles = [
  {
    entry: 'src/core/vendor/csg/api.js',
    outfile: 'src/core/vendor/csg/dist/api.esm.js',
  },
  {
    entry: 'src/core/vendor/csg/csg.js',
    outfile: 'src/core/vendor/csg/dist/csg.esm.js',
  },
  {
    entry: 'src/core/geometry/earcut.js',
    outfile: 'src/core/geometry/earcut.esm.js',
  },
];

const toAbsolute = (repoRelativePath) => path.join(projectRoot, repoRelativePath);

const main = async () => {
  for (const bundle of bundles) {
    await build({
      entryPoints: [toAbsolute(bundle.entry)],
      outfile: toAbsolute(bundle.outfile),
      bundle: true,
      format: 'esm',
      platform: 'browser',
      target: ['es2020'],
      logLevel: 'silent',
      sourcemap: false,
      legalComments: 'none',
      banner: { js: generatedBanner },
    });

    console.log(`Generated ${bundle.outfile}`);
  }
};

main().catch((error) => {
  console.error('Failed to generate geometry adapters.');
  console.error(error);
  process.exit(1);
});
